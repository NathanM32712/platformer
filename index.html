<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Map Editor — Play Launcher</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#0f1220; --panel:#0b0f1a; --muted:#9aa0b4; --accent:#58c4ff;
    --tile-size:32px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e8eef8}
  .app{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;height:100%;box-sizing:border-box}
  header{grid-column:1/-1;display:flex;align-items:center;gap:12px}
  h1{font-size:16px;margin:0}
  .panel{background:var(--panel);border-radius:10px;padding:12px;box-sizing:border-box}
  .left{display:flex;flex-direction:column;gap:12px}
  .palette{display:flex;flex-wrap:wrap;gap:8px}
  .sw{width:56px;height:44px;border-radius:8px;display:grid;place-items:center;cursor:pointer;border:1px solid #0004}
  .sw.active{outline:3px solid #66d3ff33}
  .sw code{font-family:monospace;color:#fff}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid-wrap{background:#071022;border-radius:8px;padding:8px;overflow:auto}
  .grid{display:grid;gap:2px;touch-action:none}
  .cell{width:var(--tile-size);height:var(--tile-size);border-radius:4px;box-sizing:border-box;border:1px solid transparent;cursor:crosshair;display:flex;align-items:center;justify-content:center}
  .cell[data-t="A"]{background:linear-gradient(#071022,#071022); border:1px dashed #0006;}
  .cell[data-t="b"]{background:#7a4f2d; box-shadow:inset 0 -6px 0 #6a3f1d;}
  .cell[data-t="B"]{background:#9b5e34; box-shadow:inset 0 -6px 0 #7a4f2d;}
  .cell[data-t="g"]{background:#4a3a2a; opacity:0.95;}
  .cell[data-t="c"]{background:linear-gradient(#ffd24d,#ffcf4a); border-radius:6px;}
  .cell[data-t="^"]{background:linear-gradient(#c33,#a22); clip-path:polygon(50% 10%, 90% 90%, 10% 90%);}
  .cell[data-t="s"]{background:#66ddff; box-shadow:inset 0 -4px 0 #3fb8e6; border-radius:6px;}
  .cell[data-t="h"], .cell[data-t="v"]{background:#7a6fff; box-shadow:inset 0 -6px 0 #5a4fff;}
  .cell[data-t="w"]{background:transparent; border-top:3px solid #333; border-radius:0;}
  .cell[data-t="G"]{background:#5fd866; box-shadow:inset 0 -6px 0 #3fa84a; border-radius:6px;}
  .cell[data-t="#"]{outline:2px solid #fff4; background:linear-gradient(#111,#222);}

  .right{display:flex;flex-direction:column;gap:12px}
  .game-preview{background:#071022;border-radius:8px;padding:12px;min-height:420px;display:flex;flex-direction:column;gap:8px}
  textarea#mapText{width:100%;height:160px;background:#071022;color:#e8eef8;border:1px solid #22263a;padding:8px;border-radius:8px;font-family:monospace;resize:vertical}
  button{background:#0f1724;color:#e8eef8;border:1px solid #22263a;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.primary{background:var(--accent);color:#071022;border-color:#66d3ff;font-weight:600}
  .small{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px;align-items:center}
  .footer{grid-column:1/-1;color:var(--muted);font-size:13px;padding-top:6px}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Map Editor — Play Launcher</h1>
    <div style="margin-left:auto" class="small">Click Play to open <code>playplatform.html</code> with the current map</div>
  </header>

  <!-- LEFT: Editor -->
  <div class="panel left">
    <div class="row">
      <strong>Palette</strong>
      <div style="margin-left:auto" class="small">Click to select, drag to paint</div>
    </div>

    <div class="palette" id="palette"></div>

    <div class="row controls">
      <label class="small">Cols <input id="cols" type="number" value="60" min="10" max="400" style="width:70px;margin-left:6px"></label>
      <label class="small">Rows <input id="rows" type="number" value="15" min="6" max="60" style="width:70px;margin-left:6px"></label>
      <button id="resizeBtn">Resize</button>
      <button id="clearBtn">Clear (all Air)</button>
    </div>

    <div class="grid-wrap" id="gridWrap" style="height:420px">
      <div id="grid" class="grid" tabindex="0" aria-label="Map editor play space"></div>
    </div>

    <div class="row">
      <button id="exportBtn">Export to Text</button>
      <button id="copyBtn">Copy Text</button>
      <button id="loadToGame">Load into Game Text</button>
      <button id="ensureSupport">Ensure Spawn Support</button>
    </div>

    <div class="small">Tip: Right-click a cell to erase it to Air. Start (#) and Goal (G) are available in the palette.</div>
  </div>

  <!-- RIGHT: Preview & Text -->
  <div class="right">
    <div class="panel game-preview">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Play Space Preview</strong>
        <div class="small">This grid is the play area — it looks like the in-game tiles</div>
      </div>

      <div style="flex:1;display:flex;align-items:center;justify-content:center">
        <canvas id="previewCanvas" width="960" height="320" style="border-radius:8px;background:#071022"></canvas>
      </div>

      <div class="row">
        <button id="btnPlay" class="primary">Play (open playplatform.html)</button>
        <button id="startGame">Start (preview)</button>
        <button id="pauseGame">Pause</button>
        <div style="margin-left:auto" id="status" class="small">No map loaded</div>
      </div>
    </div>

    <div class="panel">
      <div class="small">Map text (editable)</div>
      <textarea id="mapText" spellcheck="false"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="loadFromText">Load into Editor</button>
        <button id="loadSample">Load Sample</button>
      </div>
    </div>
  </div>

  <div class="footer">Editor play space = game tiles. All cells default to Air until painted.</div>
</div>

<script>
/* Editor + Play launcher
   - When Play is clicked: current map text is saved to localStorage under key "playplatform_map"
     then playplatform.html is opened in a new tab/window. playplatform.html can read that key.
   - Editor grid defaults to Air ('A') until painted.
*/

const PALETTE = [
  {k:'A', label:'Air', color:'#071022'},
  {k:'b', label:'Block', color:'#7a4f2d'},
  {k:'B', label:'Brick', color:'#9b5e34'},
  {k:'g', label:'Ghost', color:'#4a3a2a'},
  {k:'c', label:'Coin', color:'#ffd24d'},
  {k:'^', label:'Spike', color:'#c33'},
  {k:'s', label:'Spring', color:'#66ddff'},
  {k:'h', label:'Plat H', color:'#7a6fff'},
  {k:'v', label:'Plat V', color:'#7a6fff'},
  {k:'w', label:'One-way', color:'#333'},
  {k:'G', label:'Goal', color:'#5fd866'},
  {k:'#', label:'Start', color:'#ffffff'}
];

const gridEl = document.getElementById('grid');
const paletteEl = document.getElementById('palette');
const mapText = document.getElementById('mapText');
const colsInput = document.getElementById('cols');
const rowsInput = document.getElementById('rows');
const resizeBtn = document.getElementById('resizeBtn');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const copyBtn = document.getElementById('copyBtn');
const loadToGame = document.getElementById('loadToGame');
const ensureSupport = document.getElementById('ensureSupport');
const loadFromText = document.getElementById('loadFromText');
const loadSample = document.getElementById('loadSample');
const previewCanvas = document.getElementById('previewCanvas');
const previewCtx = previewCanvas.getContext('2d');
const btnPlay = document.getElementById('btnPlay');
const statusEl = document.getElementById('status');

let COLS = parseInt(colsInput.value,10);
let ROWS = parseInt(rowsInput.value,10);
let currentTool = 'b';
let isPainting = false;
let isErasing = false;
let gridData = []; // 2D array of chars

/* build palette UI */
PALETTE.forEach(p=>{
  const d = document.createElement('div');
  d.className='sw';
  d.title = p.label + ' ('+p.k+')';
  d.dataset.k = p.k;
  d.style.background = p.color;
  d.innerHTML = `<code>${p.k}</code>`;
  d.addEventListener('click', ()=> selectTool(p.k));
  paletteEl.appendChild(d);
});
function selectTool(k){
  currentTool = k;
  document.querySelectorAll('.sw').forEach(s=>s.classList.toggle('active', s.dataset.k===k));
}
selectTool('b');

/* create grid (all Air by default) */
function makeGrid(cols, rows){
  COLS = cols; ROWS = rows;
  gridEl.innerHTML = '';
  gridEl.style.gridTemplateColumns = `repeat(${COLS}, var(--tile-size))`;
  gridData = Array.from({length:ROWS}, ()=>Array.from({length:COLS}, ()=>'A'));
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const cell = document.createElement('div');
      cell.className='cell';
      cell.dataset.r = r; cell.dataset.c = c; cell.dataset.t = 'A';
      cell.addEventListener('pointerdown', onPointerDown);
      cell.addEventListener('pointerenter', onPointerEnter);
      cell.addEventListener('contextmenu', e=>{ e.preventDefault(); eraseCell(cell); updateMapText(); renderPreview(); });
      gridEl.appendChild(cell);
    }
  }
  updateMapText();
  renderPreview();
}

/* set/erase cell */
function setCell(cell, t){
  cell.dataset.t = t;
  gridData[+cell.dataset.r][+cell.dataset.c] = t;
  cell.setAttribute('data-t', t);
}
function eraseCell(cell){
  setCell(cell,'A');
}

/* pointer handlers */
function onPointerDown(e){
  e.preventDefault();
  const cell = e.currentTarget;
  isPainting = true;
  isErasing = (e.button === 2) || currentTool === 'A';
  if(isErasing) eraseCell(cell);
  else setCell(cell, currentTool);
  window.addEventListener('pointerup', onPointerUp);
  renderPreview();
}
function onPointerEnter(e){
  if(!isPainting) return;
  const cell = e.currentTarget;
  if(isErasing) eraseCell(cell);
  else setCell(cell, currentTool);
  renderPreview();
}
function onPointerUp(e){
  isPainting = false;
  isErasing = false;
  updateMapText();
  window.removeEventListener('pointerup', onPointerUp);
}

/* controls */
resizeBtn.addEventListener('click', ()=>{
  const nc = Math.max(10, Math.min(400, parseInt(colsInput.value,10)||60));
  const nr = Math.max(6, Math.min(60, parseInt(rowsInput.value,10)||15));
  const old = gridData;
  makeGrid(nc,nr);
  for(let r=0;r<Math.min(nr,old.length);r++){
    for(let c=0;c<Math.min(nc,old[0].length);c++){
      gridData[r][c] = old[r][c];
      const cell = gridEl.children[r*nc + c];
      if(cell) cell.dataset.t = old[r][c];
    }
  }
  updateMapText();
  renderPreview();
});
clearBtn.addEventListener('click', ()=>{ for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){ gridData[r][c]='A'; const cell = gridEl.children[r*COLS+c]; if(cell) cell.dataset.t='A'; } updateMapText(); renderPreview(); });

exportBtn.addEventListener('click', ()=>{ updateMapText(); alert('Map text updated below.'); });
copyBtn.addEventListener('click', ()=>{ mapText.select(); document.execCommand('copy'); status('Copied map text'); });

function updateMapText(){
  const rows = gridData.map(r=>r.join(''));
  mapText.value = rows.join('\n');
}

/* ensure spawn support: put 'b' under every '#' */
ensureSupport.addEventListener('click', ()=>{
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(gridData[r][c]==='#'){
        if(r >= ROWS-1){
          gridData[r][c] = 'b';
          gridData[Math.max(0,ROWS-2)][c] = '#';
        } else {
          const below = gridData[r+1][c];
          if(!below || below==='A' || below==='g' || below==='c' || below==='w') gridData[r+1][c] = 'b';
        }
      }
    }
  }
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){ const cell = gridEl.children[r*COLS+c]; if(cell) cell.dataset.t = gridData[r][c]; }
  updateMapText();
  renderPreview();
  status('Spawn support ensured');
});

/* load from text into editor */
loadFromText.addEventListener('click', ()=>{
  const rows = mapText.value.replace(/\r/g,'').split('\n');
  const w = Math.max(...rows.map(r=>r.length));
  const h = rows.length;
  colsInput.value = w; rowsInput.value = h;
  makeGrid(w,h);
  for(let r=0;r<h;r++){
    for(let c=0;c<w;c++){
      const ch = (rows[r] && rows[r][c]) ? rows[r][c] : 'A';
      gridData[r][c] = ch;
      const cell = gridEl.children[r*w+c];
      if(cell) cell.dataset.t = ch;
    }
  }
  updateMapText();
  renderPreview();
  status('Loaded map into editor');
});

/* sample map */
loadSample.addEventListener('click', ()=>{
  const sample = generateSampleMap(120,15);
  mapText.value = sample;
  loadFromText.click();
});

/* initial grid */
makeGrid(COLS, ROWS);

/* preview rendering */
function renderPreview(){
  const ctx = previewCtx;
  const W = previewCanvas.width, H = previewCanvas.height;
  ctx.clearRect(0,0,W,H);
  const cellW = Math.floor(W / COLS);
  const cellH = Math.floor(H / ROWS);
  const s = Math.max(4, Math.min(cellW, cellH));
  const offsetX = Math.floor((W - s*COLS)/2);
  const offsetY = Math.floor((H - s*ROWS)/2);
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const t = gridData[r][c];
      const x = offsetX + c*s, y = offsetY + r*s;
      drawTilePreview(ctx, t, x, y, s, s);
    }
  }
}
function drawTilePreview(ctx, t, x, y, w, h){
  ctx.save();
  if(t==='A'){ ctx.fillStyle='#071022'; ctx.fillRect(x,y,w,h); ctx.strokeStyle='#0006'; ctx.strokeRect(x+1,y+1,w-2,h-2); }
  else if(t==='b'){ ctx.fillStyle='#7a4f2d'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#6a3f1d'; ctx.fillRect(x, y + Math.floor(h*0.6), w, Math.floor(h*0.4)); }
  else if(t==='B'){ ctx.fillStyle='#9b5e34'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#7a4f2d'; ctx.fillRect(x, y + Math.floor(h*0.6), w, Math.floor(h*0.4)); }
  else if(t==='g'){ ctx.fillStyle='#4a3a2a'; ctx.fillRect(x,y,w,h); }
  else if(t==='c'){ ctx.fillStyle='#ffd24d'; ctx.beginPath(); ctx.arc(x+w/2,y+h/2,Math.max(2,Math.min(w,h)/4),0,Math.PI*2); ctx.fill(); }
  else if(t==='^'){ ctx.fillStyle='#c33'; ctx.beginPath(); ctx.moveTo(x+w/2,y+Math.max(2,h*0.15)); ctx.lineTo(x+Math.max(2,w*0.85),y+h-Math.max(2,h*0.15)); ctx.lineTo(x+Math.max(2,w*0.15),y+h-Math.max(2,h*0.15)); ctx.closePath(); ctx.fill(); }
  else if(t==='s'){ ctx.fillStyle='#66ddff'; ctx.fillRect(x+Math.floor(w*0.12), y+Math.floor(h*0.6), Math.floor(w*0.76), Math.floor(h*0.28)); }
  else if(t==='h' || t==='v'){ ctx.fillStyle='#7a6fff'; ctx.fillRect(x,y,w,h); }
  else if(t==='w'){ ctx.fillStyle='#071022'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#333'; ctx.fillRect(x, y + Math.floor(h*0.7), w, Math.floor(h*0.18)); }
  else if(t==='G'){ ctx.fillStyle='#5fd866'; ctx.fillRect(x+Math.floor(w*0.25), y+Math.floor(h*0.12), Math.floor(w*0.5), Math.floor(h*0.76)); }
  else if(t==='#'){ ctx.fillStyle='#111'; ctx.fillRect(x,y,w,h); ctx.strokeStyle='#fff4'; ctx.strokeRect(x+2,y+2,w-4,h-4); }
  else { ctx.fillStyle='#071022'; ctx.fillRect(x,y,w,h); }
  ctx.restore();
}

/* helper functions */
function status(msg){ statusEl.textContent = msg; setTimeout(()=>{ if(statusEl.textContent===msg) statusEl.textContent=''; },1400); }

/* generate a small sample map */
function generateSampleMap(W=120,H=15){
  const grid = Array.from({length:H}, ()=>Array.from({length:W}, ()=>'A'));
  for(let x=0;x<W;x++) grid[H-1][x] = (x%11===0)?'B':'b';
  for(let i=0;i<8;i++){
    const rw = 8 + Math.floor(Math.random()*18);
    const rh = 3 + Math.floor(Math.random()*5);
    const rx = 6 + Math.floor(Math.random()*(W-12-rw));
    const ry = 2 + Math.floor(Math.random()*(H-6-rh));
    for(let y=ry;y<ry+rh;y++) for(let x=rx;x<rx+rw;x++) grid[y][x] = 'g';
    const dx = rx + Math.floor(Math.random()*(rw-2))+1;
    grid[ry+rh-1][dx] = 'A';
    if(Math.random()<0.6) grid[ry+1][rx+1] = 'c';
  }
  for(let seg=0; seg<Math.floor(W/12); seg++){
    const bx = seg*12 + 6;
    for(let x=bx; x<bx+8 && x<W-1; x+=2) grid[H-4][x] = (Math.random()<0.2)?'c':'b';
    if(Math.random()<0.2) grid[H-5][bx+3] = 'h';
  }
  grid[H-3][2] = '#';
  grid[H-4][W-6] = 'G';
  return grid.map(r=>r.join('')).join('\n');
}

/* load into game text area (no automatic play) */
loadToGame.addEventListener('click', ()=>{
  updateMapText();
  status('Map copied to text area');
});

/* Play button: save current map to localStorage and open playplatform.html */
btnPlay.addEventListener('click', ()=>{
  updateMapText();
  const text = mapText.value || '';
  try {
    // Save map to localStorage so playplatform.html can read it
    localStorage.setItem('playplatform_map', text);
    // Open playplatform.html in a new tab
    window.open('playplatform.html', '_blank');
    status('Opening playplatform.html (map saved to localStorage)');
  } catch (err) {
    alert('Unable to save map to localStorage. You can copy the map text and paste it into playplatform.html manually.');
  }
});

/* preview start/pause (simple visual feedback) */
document.getElementById('startGame').addEventListener('click', ()=> status('Preview started (visual only)'));
document.getElementById('pauseGame').addEventListener('click', ()=> status('Preview paused'));

/* initial sample */
mapText.value = generateSampleMap(120,15);
loadFromText.click();
renderPreview();
</script>
</body>
</html>
